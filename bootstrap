#!/usr/bin/env bash

export DOTFILES=$HOME/Developer/dotfiles

1_prompt_sudo() {
    sudo -v

    # Keep-alive: update existing `sudo` time stamp until `.osx` has finished
    while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
}

2_create_directories() {
    echo 'Create custom_credentials directory (if not exists)'
    mkdir -p $DOTFILES/.custom_credentials
    mkdir -p $HOME/.rbenv
    mkdir -p $HOME/.ssh
    mkdir -p $HOME/.oh-my-zsh/custom/themes
    mkdir -p $HOME/.oh-my-zsh/custom/plugins
    mkdir -p $HOME/.tmux/plugins
    mkdir -p $HOME/.tmux/resurrect
}

3_setup_git() {
    ln -sf $DOTFILES/.gitconfig $HOME/.gitconfig
}

4_setup_ssh() {
    if [[ ! $(ls -A "$HOME/.ssh") ]]; then
        git_user=$(git config --get user.email)
        if [ -z "$git_user" ]; then read -r -p 'Enter your git email: ' git_user; fi
        ssh-keygen -t ed25519 -C "$git_user" -f "$HOME/.ssh/id_ed25519" -N ''
        eval "$(ssh-agent -s)"
        echo """Host *
  AddKeysToAgent yes
  IdentityFile ~/.ssh/id_ed25519""" > "$HOME/.ssh/config"
        pbcopy < "$HOME/.ssh/id_ed25519.pub"
        open -a Safari https://github.com/settings/keys
        echo 'Your ssh public key has been copied to the keyboard. Confirm when you have entered the key in GitHub (y)'
        while : ; do
            read -n 1 k <&1
            if [[ $k = y ]] ; then
                printf "\nContinuing setup\n"
                break
            else
                echo "Confirm when you have entered the key in GitHub"
            fi
        done
    fi
}

5_clone_dotfiles() {
    echo "Cloning dotfiles into $DOTFILES"
    cd $DOTFILES
    if [ $(git rev-parse --is-inside-work-tree) ]; then
        return
    fi
    git init
    git remote add origin git@github.com:namolnad/dotfiles.git
    git fetch origin
    git checkout -b master --track origin/master
    cd -
}

6_symlink_customizations() {
    # Remove existing directory symlinks if exists
    rm -rf $HOME/.vim $HOME/Developer/Scripts

    # Setup symlinks
    ln -fs $DOTFILES/.config/* $HOME/.config
    ln -fs $DOTFILES/.tmux.conf $HOME/.tmux.conf
    ln -fs $DOTFILES/.vim $HOME/.vim
    ln -fs $DOTFILES/Scripts $HOME/Developer/Scripts
    ln -fs $DOTFILES/.oh-my-zsh/custom/*.zsh $HOME/.oh-my-zsh/custom
    for FILE in $DOTFILES/.oh-my-zsh/custom/*.zsh; do ln -fs "$FILE" "$HOME/.oh-my-zsh/custom"; done
    for FILE in $DOTFILES/.oh-my-zsh/custom/themes/*; do ln -fs "$FILE" "$HOME/.oh-my-zsh/custom/themes"; done
    for FILE in $DOTFILES/.oh-my-zsh/custom/plugins/*; do ln -fs "$FILE" "$HOME/.oh-my-zsh/custom/plugins"; done
    ln -fs $DOTFILES/.bash_profile $HOME/.bash_profile
    for FILE in $DOTFILES/.*rc; do ln -fs "$FILE" "$HOME"; done
}

7_install_homebrew() {
    echo 'Checking if homebrew is installed'
    if ! [ -x "$(command -v brew)" ]; then
        echo 'Installing homebrew'
        PATH="/opt/homebrew/bin:$PATH"
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        if [ -f /opt/homebrew/bin/brew ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi
    fi
}

8_setup_ruby_environment() {
    echo 'Installing rbenv'
    brew install rbenv
    ln -fs $DOTFILES/.rbenv/version $HOME/.rbenv
    echo 'Installing global ruby'
    rbenv install -s $(cat ~/.rbenv/version)
    eval "$(rbenv init -)"
    echo 'Installing bundler'
    gem install bundler
    rbenv rehash
}

9_install_dependencies() {
    echo 'Installing gems'
    bundle install
    echo 'Running brew bundle'
    brew bundle
    echo 'Installing FZF'
    yes | $(brew --prefix)/opt/fzf/install
    echo 'Installing Oh My Zsh'
    sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
    echo 'Cloning tmux plugin manager'
    git clone https://github.com/tmux-plugins/tpm $HOME/.tmux/plugins/tpm
}

10_symlink_scripts() {
    script_home=$HOME/Developer/Scripts
    destination=/usr/local/opt

    sudo mkdir -p $destination

    sudo ln -sf $script_home/git-stashfiles $destination
    sudo ln -sf $script_home/git-rebase-origin $destination
    sudo ln -sf $script_home/git-worktree-branch $destination
}

11_setup_system_settings() {
    $DOTFILES/.macOS
}

12_init_submodules() {
    echo 'Initializing all submodules'
    git submodule update --init --recursive
}

13_install_automator_tasks() {
    echo 'Installing automator tasks'
    # TODO: Install tasks from Dans-scripts
    # See https://apple.stackexchange.com/questions/343258/how-to-deploy-automator-workflow-to-clients for migration tactics
}

14_display_manual_tasks_remaining() {
    echo """
    Tasks remaining:
    1) Ensure Dropbox syncing is set up
    2) Point development application settings to \"$HOME/Dropbox/.dev_sync\"
    3) Grant full disk access to Alfred
    4) Install GPG Suite; set up GPG signing
    """
}

echo 'Bootstrapping machine'

# NOTE: Order is important
1_prompt_sudo
2_create_directories
3_setup_git
4_setup_ssh
5_clone_dotfiles
6_symlink_customizations
7_install_homebrew
8_setup_ruby_environment
9_install_dependencies
10_symlink_scripts
11_setup_system_settings
12_init_submodules
13_install_automator_tasks
14_display_manual_tasks_remaining
